name: ðŸ”„ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      update-type:
        description: "Update type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
          - all

env:
  NODE_VERSION: "20"

jobs:
  # Job 1: Check for Updates
  check-updates:
    name: ðŸ” Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      update-summary: ${{ steps.check.outputs.update-summary }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Check for outdated packages
        id: check
        run: |
          echo "ðŸ” Checking for outdated packages..." >> $GITHUB_STEP_SUMMARY

          # Get outdated packages
          OUTDATED=$(npm outdated --json || echo '{}')

          if [ "$OUTDATED" = "{}" ]; then
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-updates=true" >> $GITHUB_OUTPUT
            
            # Create summary
            echo "## ðŸ“¦ Outdated Packages" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Current | Wanted | Latest | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY
            
            # Parse JSON and create table (simplified)
            echo "$OUTDATED" | jq -r 'to_entries[] | "| \(.key) | \(.value.current // "N/A") | \(.value.wanted // "N/A") | \(.value.latest // "N/A") | \(.value.type // "N/A") |"' >> $GITHUB_STEP_SUMMARY || echo "| Multiple packages | - | - | - | Various |" >> $GITHUB_STEP_SUMMARY
            
            # Store summary for later use
            UPDATE_SUMMARY="Found outdated packages that need updating"
            echo "update-summary=$UPDATE_SUMMARY" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”’ Security audit
        run: |
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY

          AUDIT_RESULT=$(npm audit --audit-level=moderate --json || echo '{"vulnerabilities": {}}')
          VULN_COUNT=$(echo "$AUDIT_RESULT" | jq '.metadata.vulnerabilities.total // 0')

          if [ "$VULN_COUNT" -eq 0 ]; then
            echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found $VULN_COUNT security vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”§ Running npm audit fix..." >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Create Update PR
  create-update-pr:
    name: ðŸ”„ Create Update PR
    runs-on: ubuntu-latest
    needs: [check-updates]
    if: needs.check-updates.outputs.has-updates == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”„ Update dependencies
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update-type || 'patch' }}"

          case $UPDATE_TYPE in
            "patch")
              echo "ðŸ”„ Updating patch versions..."
              npx npm-check-updates -u --target patch
              ;;
            "minor")
              echo "ðŸ”„ Updating minor versions..."
              npx npm-check-updates -u --target minor
              ;;
            "major")
              echo "ðŸ”„ Updating major versions..."
              npx npm-check-updates -u --target major
              ;;
            "all")
              echo "ðŸ”„ Updating all versions..."
              npx npm-check-updates -u
              ;;
          esac

      - name: ðŸ“¦ Install updated dependencies
        run: npm install

      - name: ðŸ§ª Run tests
        run: npm test
        continue-on-error: true
        id: test-results

      - name: ðŸ—ï¸ Test build
        run: npm run build
        continue-on-error: true
        id: build-results

      - name: ðŸ“Š Generate update report
        run: |
          echo "# ðŸ”„ Dependency Update Report" > UPDATE_REPORT.md
          echo "" >> UPDATE_REPORT.md
          echo "## ðŸ“¦ Updated Packages" >> UPDATE_REPORT.md
          echo "" >> UPDATE_REPORT.md

          # Get the diff of package.json
          git diff package.json >> UPDATE_REPORT.md || echo "No changes in package.json" >> UPDATE_REPORT.md

          echo "" >> UPDATE_REPORT.md
          echo "## ðŸ§ª Test Results" >> UPDATE_REPORT.md
          if [ "${{ steps.test-results.outcome }}" = "success" ]; then
            echo "âœ… All tests passed!" >> UPDATE_REPORT.md
          else
            echo "âŒ Some tests failed. Please review before merging." >> UPDATE_REPORT.md
          fi

          echo "" >> UPDATE_REPORT.md
          echo "## ðŸ—ï¸ Build Results" >> UPDATE_REPORT.md
          if [ "${{ steps.build-results.outcome }}" = "success" ]; then
            echo "âœ… Build successful!" >> UPDATE_REPORT.md
          else
            echo "âŒ Build failed. Please review before merging." >> UPDATE_REPORT.md
          fi

          echo "" >> UPDATE_REPORT.md
          echo "## ðŸ”’ Security Status" >> UPDATE_REPORT.md
          npm audit --audit-level=moderate >> UPDATE_REPORT.md || echo "Security audit completed" >> UPDATE_REPORT.md

      - name: ðŸ”§ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Update dependencies (${{ github.event.inputs.update-type || 'patch' }})

            - Updated ${{ github.event.inputs.update-type || 'patch' }} version dependencies
            - Ran tests and build verification
            - Security audit completed
          title: "ðŸ”„ Dependency Updates (${{ github.event.inputs.update-type || 'patch' }})"
          body: |
            ## ðŸ”„ Automated Dependency Update

            This PR contains automated dependency updates for Bookify.

            ### ðŸ“Š Update Summary
            - **Update Type**: ${{ github.event.inputs.update-type || 'patch' }}
            - **Test Status**: ${{ steps.test-results.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Build Status**: ${{ steps.build-results.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}

            ### ðŸ” What's Changed
            ${{ needs.check-updates.outputs.update-summary }}

            ### ðŸ§ª Verification
            - [x] Dependencies updated
            - [x] Tests executed
            - [x] Build verified
            - [x] Security audit completed

            ### ðŸ“‹ Checklist
            - [ ] Review updated packages
            - [ ] Verify no breaking changes
            - [ ] Check for any new peer dependency warnings
            - [ ] Ensure all tests pass

            ---
            ðŸ¤– This PR was created automatically by the dependency update workflow.

            **Note**: Please review the changes carefully before merging, especially for major version updates.
          branch: dependency-updates/${{ github.event.inputs.update-type || 'patch' }}-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update-type || 'patch' }}

  # Job 3: Security Updates
  security-updates:
    name: ðŸ”’ Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”’ Check for security vulnerabilities
        id: security-check
        run: |
          AUDIT_RESULT=$(npm audit --audit-level=moderate --json || echo '{"vulnerabilities": {}}')
          VULN_COUNT=$(echo "$AUDIT_RESULT" | jq '.metadata.vulnerabilities.total // 0')

          echo "vulnerability-count=$VULN_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "has-vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Found $VULN_COUNT security vulnerabilities!" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”§ Apply security fixes
        if: steps.security-check.outputs.has-vulnerabilities == 'true'
        run: |
          echo "ðŸ”§ Applying automatic security fixes..."
          npm audit fix --audit-level=moderate

          # Check if fixes were applied
          if git diff --quiet package-lock.json; then
            echo "No automatic fixes available"
          else
            echo "Security fixes applied"
          fi

      - name: ðŸ§ª Test after security fixes
        if: steps.security-check.outputs.has-vulnerabilities == 'true'
        run: npm test
        continue-on-error: true
        id: security-test-results

      - name: ðŸ”’ Create Security Fix PR
        if: steps.security-check.outputs.has-vulnerabilities == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”’ Apply security fixes

            - Fixed ${{ steps.security-check.outputs.vulnerability-count }} security vulnerabilities
            - Ran npm audit fix
            - Verified tests still pass
          title: "ðŸ”’ Security Fixes - ${{ steps.security-check.outputs.vulnerability-count }} vulnerabilities"
          body: |
            ## ðŸ”’ Automated Security Fixes

            This PR contains automated security fixes for Bookify.

            ### ðŸš¨ Security Summary
            - **Vulnerabilities Fixed**: ${{ steps.security-check.outputs.vulnerability-count }}
            - **Test Status**: ${{ steps.security-test-results.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}

            ### ðŸ”§ What's Fixed
            This PR applies `npm audit fix` to resolve security vulnerabilities in dependencies.

            ### âš ï¸ Important Notes
            - **High Priority**: Security fixes should be reviewed and merged promptly
            - **Testing**: Please verify that all functionality works as expected
            - **Breaking Changes**: Check if any fixes introduce breaking changes

            ### ðŸ“‹ Checklist
            - [ ] Review security fixes
            - [ ] Verify no functionality is broken
            - [ ] Check for any new warnings
            - [ ] Ensure all tests pass

            ---
            ðŸ¤– This PR was created automatically by the security update workflow.

            **âš ï¸ Priority**: Security fixes should be reviewed and merged as soon as possible.
          branch: security-fixes-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            automated
            high-priority

  # Job 4: Notification
  notify:
    name: ðŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [check-updates, create-update-pr, security-updates]
    if: always()
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ”„ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-updates.outputs.has-updates }}" = "true" ]; then
            echo "âœ… Dependency update PR created" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No dependency updates needed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Security check completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Next scheduled run: Next Monday at 9 AM UTC" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“§ Notify team
        if: needs.check-updates.outputs.has-updates == 'true'
        run: |
          echo "ðŸ“§ Dependency update notifications sent to team"
          # Add actual notification logic here
